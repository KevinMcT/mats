<html>
<meta charset="UTF-8"/>
<head>
    <style>
        #request_table, td {
            border: 1px solid black;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: fixed;
            width: 1500px;
        }

        td {
            width: 30px;
            overflow: hidden;
        }

    </style>
</head>
<body>
<h1 id="title_heading">Continuous, sequential requests</h1>
Sends off requests one by one, immediately sending off the next when the last reply is received.<br>
After one "screenful", timings are calculated, and we start over. The memory situation can be viewed over time in Dev Tools.<br>
<i id="statistics">Here will be information...</i>

<script src="MatsSocket.js"></script>

<script>
    function tableCreate(rows, columns) {
        var body = document.body;
        var table = document.createElement('table');
        table.id = "request_table";

        for (var i = 0; i < rows; i++) {
            var tr = table.insertRow();
            for (var j = 0; j < columns; j++) {
                var cellNum = j * rows + i;
                var td = tr.insertCell();
                td.id = "request_" + cellNum;
                td.innerHTML = "x";
            }
        }
        body.appendChild(table);
    }

    var rows = 40;
    var columns = 25;

    tableCreate(rows, columns);
    var total = rows * columns;

    document.getElementById("title_heading").innerText = "Continuous, sequential requests, " + total + " per round.";

    var matsSocket = new mats.MatsSocket("TestApp", "1.2.3",
        ["ws://localhost:8080/matssocket", "ws://localhost:8081/matssocket"]);
    matsSocket.setCurrentAuthorization("DummyAuth:" + (Date.now() + 100000), -1);

    var sumTimeMillis = 0; // Sum of millis per message, to get average.

    var startMillis = Date.now();

    var cells = [];
    for (var i = 0; i < total; i++) {
        cells[i] = document.getElementById("request_" + i);
    }

    function doRequest(cellNum) {
        var requestCell = cells[cellNum];
        requestCell.innerText = "Req!";

        // Fire off the MatsSocket request
        matsSocket.request("Test.single", cellNum + ":" + matsSocket.id(6),
            // The Request DTO
            {
                string: "Request String:" + cellNum,
                number: Math.E * cellNum
            },
            // This is the Reply-callback
            function (event) {
                // Setting data in Table's cell
                var timeTakenMs = Date.now() - event.clientMessageCreated;
                sumTimeMillis += timeTakenMs;
                requestCell.innerText = timeTakenMs + " ms";

                var newCellNum = cellNum + 1;
                if (newCellNum >= total) {
                    // Reset counter
                    newCellNum = 0;
                    // Update statistics
                    var now = Date.now();
                    var totalMillis = now - startMillis;
                    var averagePerMessage = totalMillis / total;
                    var throughputPerSecond = (total / totalMillis) * 1000;
                    document.getElementById("statistics").innerHTML =
                        "Total time for " + total + " requests: " + totalMillis
                        + " ms, average per message: " + averagePerMessage
                        + " ms, throughput: " + throughputPerSecond + " msg/sec";
                    startMillis = now;
                }

                doRequest(newCellNum)
            });
    }

    doRequest(0);

</script>


</body>
</html>