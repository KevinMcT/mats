<html>
<meta charset="UTF-8"/>
<body>
<h1>Testing 1, 2, 3</h1>

<script src="MatsSocket.js"></script>

<script>
    var matsSocket = new MatsSocket("TestApp", "1.2.3",
        ["ws://localhost:8080/matssocket/json", "ws://localhost:8081/matssocket/json"]);
    matsSocket.logging = true;

    // For testing, we want stable order of which URLs to connect to.
    // matsSocket.disableUrlRandomization();

    matsSocket.setAuthorizationExpiredCallback(function (event) {
        console.log("Got AuthorizationExpiredCallback from MatsSocket, regenerating Authorization header.");
        console.log(event);

        // Emulate that it takes some time to get new auth.
        setTimeout(function () {
            var now = Date.now();
            var expiry = now + 20000;
            matsSocket.setCurrentAuthorization("DummyAuth:" + expiry, expiry, 10000);
        }, 100 + (100 * Math.random()));
    });

    matsSocket.endpoint("ClientSide.testEndpoint", function (e) {
        var millis = Date.now() - e.clientMessageCreated;
        console.log("Got message! CorrelationId:" + e.correlationId + ", time taken: " + millis + "ms"
            + ", clientMessageReceivedNodename: " + e.clientMessageReceivedNodename
            + ", matsMessageReplyReceivedNodename: " + e.matsMessageReplyReceivedNodename
            + ", replyMessageToClientNodename:" + e.replyMessageToClientNodename);
    });

    matsSocket.send("Test.single", "SEND_" + matsSocket.id(6), {string: "The String", number: Math.PI});


    matsSocket.send("Test.single", "SEND-with-Promise_" + matsSocket.id(6), {string: "The String", number: Math.PI})
        .then(function (event) {
            console.log("SEND-with-Promise resolved! (message received on server) Took " + (Date.now() - event.clientMessageCreated) + "ms: " + JSON.stringify(event));
        });

    matsSocket.request("Test.single", "REQUEST-with-Promise_" + matsSocket.id(6), {string: "Request String", number: Math.E})
        .then(function (event) {
            console.log("REQUEST-with-Promise resolved! (I.e. REPLY from Mats Endpoint) Took " + (Date.now() - event.clientMessageCreated) + "ms: " + JSON.stringify(event));
        });

    matsSocket.request("Test.single", "REQUEST-with-Promise-and-receivedCallback_" + matsSocket.id(6), {string: "Request String", number: Math.E},
        function (event) {
            console.log("REQUEST receivedCallback: (message received on server). Took " + (Date.now() - event.clientMessageCreated) + "ms: " + JSON.stringify(event));
        })
        .then(function (event) {
            console.log("REQUEST-with-Promise-and-receivedCallback resolved! (I.e. REPLY from Mats Endpoint) Took " + (Date.now() - event.clientMessageCreated) + "ms: " + JSON.stringify(event));
        });

    matsSocket.pipeline(function (ms) {
        ms.requestReplyTo("Test.single", "REQUEST-with-ReplyTo_Pipeline_1_" + matsSocket.id(6),
            {string: "Messge 1", number: 100.001, requestTimestamp: Date.now()},
            "ClientSide.testEndpoint", "pipeline_1_" + matsSocket.id(10));
        ms.requestReplyTo("Test.single", "REQUEST-with-ReplyTo_Pipeline_2_" + matsSocket.id(6),
            {string: "Message 2", number: 200.002, requestTimestamp: Date.now()},
            "ClientSide.testEndpoint", "pipeline_2_" + matsSocket.id(10));
        ms.requestReplyTo("Test.single", "REQUEST-with-ReplyTo_Pipeline_3_" + matsSocket.id(6),
            {string: "Message 3", number: 300.003, requestTimestamp: Date.now()},
            "ClientSide.testEndpoint", "pipeline_3_" + matsSocket.id(10));
    });

    var ping = function () {
        setTimeout(function () {
            matsSocket.requestReplyTo("Test.single", "TraceId",
                {string: "Periodic query", number: 100.001, requestTimestamp: Date.now()},
                "ClientSide.testEndpoint", "TestTraceId_" + matsSocket.id(6));
            // ping();
        }, 500);
    };
    ping();
</script>

</body>
</html>
